

## VPN

### IPsec VPN이 필요한 이유
우리가 인터넷을 통해 데이터를 보내면, 해커나 중간 관리자가 그 내용을 몰래 훔쳐볼 수 있습니다. <br/>
일반 인터넷: 투명한 유리창이 달린 트럭에 금괴(데이터)를 싣고 달리는 것과 같습니다.<br/>
IPsec VPN: 튼튼한 장갑차(터널)에 금괴를 싣고, 내용물을 알 수 없게 암호화한 뒤, 허가된 사람만 열 수 있는 자물쇠를 채워 보내는 것입니다.<br/>

### IPsec VPN의 3대 핵심 기능

이 기술이 "안전하다"고 평가받는 이유는 크게 3가지 장치를 하기 때문입니다.<br/>

**기밀성 (Confidentiality)**: 데이터를 꼼꼼하게 암호화합니다. 중간에 누가 가로채도 내용을 읽을 수 없습니다.<br/>
**무결성 (Integrity)**: 데이터가 오는 중에 누가 1비트라도 건드렸는지 확인합니다. 변조되었다면 즉시 폐기합니다.<br/>
**인증 (Authentication)**: 데이터를 보낸 사람이 진짜 내 파트너가 맞는지 확인합니다. (가짜 라우터의 접근 차단)<br/>

### IPsec의 작동 단계

1단계 (Phase 1): 두 라우터가 서로 "우리 친하게 지내자"라고 인사하며, 
앞으로 정보를 주고받을 안전한 수다 통로를 먼저 만듭니다. (IKE Phase 1)<br/>
2단계 (Phase 2): 그 통로 안에서 실제로 데이터를 실어 나를 구체적인 규칙을 정하고 터널을 완성합니다. (IKE Phase 2)<br/>


#### Stage 1 (Phase 1): "통성명과 보안 채널 만들기"
본격적인 업무 이야기를 하기 전에, '안전하게 대화할 수 있는 작은 방'을 만드는 단계입니다.

하는 일: 서로가 진짜 본사/지사 라우터가 맞는지 확인(인증)하고, 앞으로 대화 내용을 어떤 암호로 숨길지 결정합니다.<br/>
#### 결과물: ISAKMP SA (Security Association)라는 이름의 '보안 통로'가 생깁니다.<br/>
비유: "야, 우리 귓속말할 준비 됐지? 암호는 이걸로 하자." 하고 약속하는 단계입니다.<br/>

#### Stage 2 (Phase 2): "실제 데이터용 터널 뚫기"
Stage 1에서 만든 '안전한 대화방(통로)' 안에서, 실제로 주고받을 데이터(사내 문서, 영상 등)를 어떻게 포장할지 정하는 단계입니다.

하는 일: 실제 데이터를 암호화할 알고리즘(AES, DES 등)과 방식(ESP, AH)을 결정합니다.<br/>
#### 결과물: IPsec SA라는 '진짜 데이터 터널'이 완성됩니다.<br/>
비유: "준비 끝났으니, 이제 이 상자에 물건 담아서 보낼게. 상자 테이프는 이걸로 붙이자!"라고 구체적으로 정하는 단계입니다.<br/>

#### Stage 3: "데이터 전송 (Data Transfer)"
터널이 다 만들어졌으니 실제로 데이터를 주고받는 단계입니다.

하는 일: 사용자가 보낸 일반 IP 패킷을 IPsec 터널용 패킷으로 캡슐화(Encapsulation)해서 보냅니다.<br/>
비유: 완성된 지하 터널로 실제 화물차들이 쌩쌩 달리는 상태입니다.<br/>



<img width="1388" height="631" alt="image" src="https://github.com/user-attachments/assets/248038ca-db7a-4314-9a65-800a86a4331c" />


동적 라우팅 설정


### Tunnel

#### R1
conf t<br/>
int tunnel12<br/>
ip add 10.1.12.1 255.255.255.0<br/>
no sh<br/>

tunnel source g0/0<br/>
tunnel desination 1.1.24.2<br/>


#### R2
conf t<br/>
int tunnel12<br/>
ip add  10.1.12.2 255.255.255.0<br/>
no sh<br/>

tunnel source g0/2<br/>
tunnel destination 1.1.14.1<br/>

tunnel12로 R1과 R2가 잘 이어진걸 확인 가능<br/>
tunnel13을 위해 위와같은 방법으로 동일하게 설정<br/>

외부망 인터넷 설정

#### R1~R3

conf t<br/>
router ospf 1<br/>
router-id 1.1.1.1<br/>
network 192.168.10.0 0.0.0.255 area 0<br/>
network 10.1.12.0 0.0.0.255 area 0(터널 구간또한 ospf설정)<br/>



### Phase 1

#### R1~R3
sh ctypto IKE policy<br/>
conf t<br/>
crypto isakmp policy 10<br/>
encryption aes<br/>
authentication pre-share<br/>

#### R1
crypto isakmp key cisco address 1.1.24.2<br/>
crypto isakmp key cisco address 1.1.34.3<br/>

#### R2
crypto isakmp key cisco address 1.1.14.1<br/>

#### R3
crypto isakmp key cisco address 1.1.14.1<br/>


### Phase 2

R1(config)#crypto ipsec transform-set PHASE2 esp-aes esp-md5-hmac <br/>
R1#sh crypto ipsec transform-set <br/>
Transform set PHASE2: { esp-aes esp-md5-hmac  } <br/>
   will negotiate = { Tunnel,  }, <br/>


#### 보호 대상 지정

R1(config)#ip access-list extended R2<br/>
R1(config-ext-nacl)#permit gre host 1.1.14.1 host 1.1.24.2<br/>
R1(config-ext-nacl)#ip access-list extended R3            <br/>
R1(config-ext-nacl)#permit gre host 1.1.14.1 host 1.1.34.3<br/>

R2(config)#ip access-list extended R1<br/>
R2(config-ext-nacl)#permit gre host 1.1.24.2 host 1.1.14.1<br/>

R3(config)#ip access-list extended R1<br/>
R3(config-ext-nacl)#permit gre host 1.1.34.3 host 1.1.14.1<br/>


#### 1단계, 2단계 정책 결합

R1(config)#crypto map VPN 10 ipsec-isakmp<br/>
R1(config-crypto-map)#match address R2<br/>
R1(config-crypto-map)#set peer 1.1.24.2<br/>
R1(config-crypto-map)#set transform-set PHASE2<br/>

R1(config)#crypto map VPN 20 ipsec-isakmp<br/>
R1(config-crypto-map)#match address R3<br/>
R1(config-crypto-map)#set peer 1.1.34.3<br/>
R1(config-crypto-map)#set transform-set PHASE2<br/>


R2(config-ext-nacl)#crypto map VPN 10 ipsec-isakmp<br/>
R2(config-crypto-map)#match address R1<br/>
R2(config-crypto-map)#set peer 1.1.14.1<br/>
R2(config-crypto-map)#set transform-set PHASE2<br/>

R3(config)#crypto map VPN 10 ipsec-isakmp <br/>
R3(config-crypto-map)#match address R1      <br/>
R3(config-crypto-map)#set peer 1.1.14.1<br/>
R3(config-crypto-map)#set transform-set PHASE2<br/>



#### 인터페이스 VPN 을 적용

R1(config-if)#crypto map VPN


#### 1단계 구현 확인

R1#sh crypto isakmp peers 

R1#sh crypto isakmp sa    

#### 2단계 구현 확인
R1#sh crypto ipsec sa 

#### 만들어진 세션 확인 
R1#sh crypto session detail































































































































































































